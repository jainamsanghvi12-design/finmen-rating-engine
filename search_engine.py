
"""\nFINMEN Full-Text Search Engine - Real-time search with autocomplete\nIndexing and searching across rationales, companies, and documents\n"""\n\nimport re\nimport time\nfrom typing import List, Dict, Tuple\nfrom collections import defaultdict\nimport logging\nfrom datetime import datetime\n\nlogger = logging.getLogger(__name__)\n\nclass RationalDocument:\n    """Represents an indexed rationale document"""\n    def __init__(self, doc_id: str, company: str, agency: str, rating: str,\n                 content: str, timestamp: str = None):\n        self.doc_id = doc_id\n        self.company = company\n        self.agency = agency\n        self.rating = rating\n        self.content = content\n        self.timestamp = timestamp or datetime.now().isoformat()\n        self.tokens = self._tokenize(content)\n\n    def _tokenize(self, text: str) -> List[str]:\n        """Tokenize and normalize text"""\n        # Convert to lowercase and split on non-alphanumeric\n        words = re.findall(r'\\b\\w+\\b', text.lower())\n        # Remove common stopwords\n        stopwords = {'the', 'a', 'an', 'and', 'or', 'is', 'are', 'was', 'in', 'to', 'of'}\n        return [w for w in words if w not in stopwords]\n\nclass FullTextSearchEngine:\n    """Production-grade full-text search engine"""\n    \n    def __init__(self):\n        self.documents: Dict[str, RationalDocument] = {}\n        self.inverted_index: Dict[str, List[str]] = defaultdict(list)\n        self.company_index: Dict[str, List[str]] = defaultdict(list)\n        self.agency_index: Dict[str, List[str]] = defaultdict(list)\n        self.last_updated = None\n    \n    def index_document(self, doc_id: str, company: str, agency: str, \n                      rating: str, content: str) -> bool:\n        """\n        Index a new document\n        \n        Args:\n            doc_id: Unique document identifier\n            company: Company name\n            agency: Rating agency\n            rating: Credit rating\n            content: Full rationale text\n            \n        Returns:\n            True if successfully indexed\n        """\n        try:\n            doc = RationalDocument(doc_id, company, agency, rating, content)\n            self.documents[doc_id] = doc\n            \n            # Build inverted index for full-text search\n            for token in doc.tokens:\n                if doc_id not in self.inverted_index[token]:\n                    self.inverted_index[token].append(doc_id)\n            \n            # Build company index\n            company_key = company.lower()\n            if doc_id not in self.company_index[company_key]:\n                self.company_index[company_key].append(doc_id)\n            \n            # Build agency index\n            agency_key = agency.lower()\n            if doc_id not in self.agency_index[agency_key]:\n                self.agency_index[agency_key].append(doc_id)\n            \n            self.last_updated = datetime.now().isoformat()\n            logger.info(f'Indexed document {doc_id} for company {company}')\n            return True\n            \n        except Exception as e:\n            logger.error(f'Error indexing document {doc_id}: {str(e)}')\n            return False\n    \n    def search(self, query: str, limit: int = 10, search_type: str = 'all') -> List[Dict]:\n        """\n        Search documents with various strategies\n        \n        Args:\n            query: Search query\n            limit: Maximum results to return\n            search_type: 'all', 'content', 'company', or 'agency'\n            \n        Returns:\n            List of matching documents with relevance scores\n        """\n        query = query.lower().strip()\n        results = []\n        \n        if search_type in ['all', 'company']:\n            # Exact company match\n            if query in self.company_index:\n                for doc_id in self.company_index[query]:\n                    doc = self.documents[doc_id]\n                    results.append({\n                        'doc_id': doc_id,\n                        'company': doc.company,\n                        'agency': doc.agency,\n                        'rating': doc.rating,\n                        'relevance_score': 1.0,\n                        'match_type': 'exact_company',\n                        'snippet': doc.content[:200]\n                    })\n        \n        if search_type in ['all', 'content']:\n            # Full-text search on content\n            query_tokens = query.split()\n            matching_docs = defaultdict(float)\n            \n            for token in query_tokens:\n                if token in self.inverted_index:\n                    for doc_id in self.inverted_index[token]:\n                        matching_docs[doc_id] += 1.0 / len(query_tokens)\n            \n            # Add phrase matching bonus\n            for doc_id, doc in self.documents.items():\n                if query in doc.content.lower():\n                    matching_docs[doc_id] = min(1.0, matching_docs[doc_id] + 0.5)\n            \n            for doc_id, score in matching_docs.items():\n                if doc_id not in [r.get('doc_id') for r in results]:\n                    doc = self.documents[doc_id]\n                    results.append({\n                        'doc_id': doc_id,\n                        'company': doc.company,\n                        'agency': doc.agency,\n                        'rating': doc.rating,\n                        'relevance_score': score,\n                        'match_type': 'content',\n                        'snippet': self._get_context_snippet(doc.content, query)\n                    })\n        \n        # Sort by relevance score\n        results.sort(key=lambda x: x['relevance_score'], reverse=True)\n        \n        return results[:limit]\n    \n    def autocomplete(self, prefix: str, limit: int = 10) -> List[str]:\n        """\n        Get autocomplete suggestions\n        \n        Args:\n            prefix: Search prefix\n            limit: Maximum suggestions\n            \n        Returns:\n            List of suggestions\n        """\n        prefix = prefix.lower().strip()\n        suggestions = []\n        \n        # Company name completions\n        for company_key in self.company_index.keys():\n            if company_key.startswith(prefix):\n                doc_id = self.company_index[company_key][0]\n                company = self.documents[doc_id].company\n                if company not in suggestions:\n                    suggestions.append(company)\n        \n        # Token completions\n        for token in self.inverted_index.keys():\n            if token.startswith(prefix):\n                if token not in suggestions:\n                    suggestions.append(token)\n        \n        return suggestions[:limit]\n    \n    def advanced_search(self, filters: Dict) -> List[Dict]:\n        """\n        Advanced search with filters\n        \n        Args:\n            filters: Dictionary with keys: query, agency, company, rating, date_from, date_to\n            \n        Returns:\n            Filtered search results\n        """\n        results = []\n        \n        for doc_id, doc in self.documents.items():\n            match = True\n            \n            # Apply text search filter\n            if 'query' in filters and filters['query']:\n                search_results = self.search(filters['query'], limit=1000)\n                if doc_id not in [r['doc_id'] for r in search_results]:\n                    match = False\n            \n            # Apply agency filter\n            if match and 'agency' in filters and filters['agency']:\n                if doc.agency.lower() != filters['agency'].lower():\n                    match = False\n            \n            # Apply company filter\n            if match and 'company' in filters and filters['company']:\n                if doc.company.lower() != filters['company'].lower():\n                    match = False\n            \n            # Apply rating filter\n            if match and 'rating' in filters and filters['rating']:\n                if doc.rating != filters['rating']:\n                    match = False\n            \n            if match:\n                results.append({\n                    'doc_id': doc_id,\n                    'company': doc.company,\n                    'agency': doc.agency,\n                    'rating': doc.rating,\n                    'timestamp': doc.timestamp,\n                    'snippet': doc.content[:200]\n                })\n        \n        return results\n    \n    def _get_context_snippet(self, text: str, query: str, context_length: int = 100) -> str:\n        """Get text snippet with query in context"""\n        query_lower = query.lower()\n        text_lower = text.lower()\n        \n        idx = text_lower.find(query_lower)\n        if idx == -1:\n            return text[:200]\n        \n        start = max(0, idx - context_length)\n        end = min(len(text), idx + len(query) + context_length)\n        \n        snippet = text[start:end]\n        if start > 0:\n            snippet = '...' + snippet\n        if end < len(text):\n            snippet = snippet + '...'\n        \n        return snippet\n    \n    def get_statistics(self) -> Dict:\n        """Get search engine statistics"""\n        return {\n            'total_documents': len(self.documents),\n            'total_tokens': len(self.inverted_index),\n            'total_companies': len(self.company_index),\n            'total_agencies': len(self.agency_index),\n            'last_updated': self.last_updated,\n            'memory_usage_estimate': f'{len(self.documents) * 5} KB'  # Rough estimate\n        }\n    \n    def clear_index(self):\n        """Clear all indexes"""\n        self.documents.clear()\n        self.inverted_index.clear()\n        self.company_index.clear()\n        self.agency_index.clear()\n        self.last_updated = None\n        logger.info('Search index cleared')\n\n\n# Global search engine instance\nSEARCH_ENGINE = None\n\ndef initialize_search_engine():\n    """Initialize the global search engine"""\n    global SEARCH_ENGINE\n    SEARCH_ENGINE = FullTextSearchEngine()\n\ndef index_document(doc_id: str, company: str, agency: str, rating: str, content: str):\n    """Index a document"""\n    if SEARCH_ENGINE is None:\n        initialize_search_engine()\n    return SEARCH_ENGINE.index_document(doc_id, company, agency, rating, content)\n\ndef search(query: str, limit: int = 10) -> List[Dict]:\n    """Search documents"""\n    if SEARCH_ENGINE is None:\n        initialize_search_engine()\n    return SEARCH_ENGINE.search(query, limit)\n\ndef autocomplete(prefix: str, limit: int = 10) -> List[str]:\n    """Get autocomplete suggestions"""\n    if SEARCH_ENGINE is None:\n        initialize_search_engine()\n    return SEARCH_ENGINE.autocomplete(prefix, limit)\n\ndef advanced_search(filters: Dict) -> List[Dict]:\n    """Perform advanced search with filters"""\n    if SEARCH_ENGINE is None:\n        initialize_search_engine()\n    return SEARCH_ENGINE.advanced_search(filters)\n
